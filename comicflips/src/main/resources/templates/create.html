<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Comic</title>

    <link href="https://cdn.jsdelivr.net/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
          th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}"
          rel="stylesheet" media="screen"/>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
          th:href="@{https://use.fontawesome.com/releases/v5.7.0/css/all.css}" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/webjars/jquery/3.3.1/jquery.min.js"
            th:src="@{/webjars/jquery/3.3.1/jquery.min.js}"></script>

    <script src="https://cdn.jsdelivr.net/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
            th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            th:src="@{https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js}" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>

    <script src="https://cdn.bootcss.com/fabric.js/2.7.0/fabric.min.js"
            th:src="@{https://cdn.bootcss.com/fabric.js/2.7.0/fabric.min.js}"></script>

    <style>
        body {
            padding-top: 56px;
            background-color: whitesmoke;
            overflow: visible;
        }

        canvas {
            border: 1px solid black;
            margin: 5px;
            /*z-index: 1;*/
        }

        .canvas-container {
            margin:0 auto ;
            margin-bottom: 10px;
        }

        i:hover{
            cursor: pointer;
        }

        .control:hover{
            cursor: pointer;
            background-color: ghostwhite;
        }

        .selected:hover{
            cursor: pointer;
            background-color: #e34f52;
            color: white;
        }

        hr{
            margin: 0;
        }

        .control{
            background-color: white;
            font-size: 20px;
            border-right: #dad7d9 solid 1px;
            border-bottom: #dad7d9 solid 1px;
            border-top: #dad7d9 solid 1px;
            padding-top: 20px;
            padding-bottom: 20px;
            padding-right: 20px;
            padding-left: 20px;
        }

        .import{
            background-color: lightskyblue;
            font-size: 25px;
            border-right: #dad7d9 solid 1px;
            border-bottom: #dad7d9 solid 1px;
            border-top: #dad7d9 solid 1px;
            padding: 15px 25px;
        }

        .selected{
            background-color: #e34f51;
            color: white;
        }

        #components > .card {display:inline-block;}

    </style>

</head>

<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="#" th:href="@{/}">ComicFlips</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
                        Comic
                    </a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#" th:href="@{/create}">Create Comic</a>
                        <a class="dropdown-item" href="#" th:href="@{/component}">Create Component</a>
                    </div>
                </li>
            </ul>

            <ul class="navbar-nav">
                <li class="nav-item">
                    <div class="dropdown dropdown">
                        <i class="fas fa-user-circle" style="font-size: 30px; color:white;" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></i>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="#" th:href="@{/profile}">View Profile(TEMP)</a>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>


<div class="container">
    <div class="row">
        <div class="col">
            <h3 style="text-align:center; margin-top: 1.5rem;   margin-bottom: 1.5rem;">
                <input type="text" id="title" style="text-align: center" placeholder="Comic Title"autofocus th:value="${title}">
            </h3>

            <div id = "tools" class="d-flex justify-content-center sticky-top" style="top:56px; text-align: center;">
                <i id = "addCanvas" class="control fas fa-plus-circle" style="border-left: #dad7d9 solid 1px;"></i>
                <i id = "select" class="control fas fa-mouse-pointer" style="padding-left: 23px; padding-right: 23px;"></i>
                <i id = "draw" data-toggle="collapse" data-target="#drawOptions" class="control fas fa-pencil-alt"></i>
                <i id = "circle" data-toggle="collapse" data-target="#shapeOptions" class="control far fa-circle"></i>
                <span id = "rectangle" data-toggle="collapse" data-target="#shapeOptions" class="control" style='line-height: 15px;font-size: 30px;'>&#9645;</span>
                <span id = "line" class="control" style='line-height: 20px;'>&#8213;</span>
                <span id = "triangle" data-toggle="collapse" data-target="#shapeOptions" class="control" style="font-size:25px;line-height: 20px;" >&#9651;</span>
                <i id = "image" data-toggle="collapse" data-target="#components" class="control far fa-image"></i>
                <i id = "text" class="control fas fa-font"></i>
                <i id = "eraser" class="control fas fa-eraser"></i>
                <i id = "clear" class="control fas fa-trash"></i>
                <i id = "deleteCanvas" class="control fas fa-minus-circle"></i>
            </div>

            <div id = "drawOptions" class="collapse sticky-top" style="top:70px;background-color: grey;border: #dad7d9 solid 1px;">
                <label for="drawing-line-width">Line width:</label>
                <span class="info">1</span><input type="range" value="1" min="0" max="150" id="drawing-line-width"><br>
                <label for="drawing-color">Line color:</label>
                <input type="color" value="#000000" id="drawing-color"><br>
            </div>

            <div id = "shapeOptions" class="collapse">
                <label for="shape-stroke-width">Stroke width:</label>
                <span class="info">1</span><input type="range" value="1" min="0" max="150" id="shape-stroke-width"><br>
                <label for="shape-stroke">Stroke color:</label>
                <input type="color" value="#000000" id="shape-stroke"><br>
                <label for="shape-fill">Fill:</label>
                <input type="color" value="#000000" id="shape-fill"><br>
            </div>

            <div id="components" class="collapse" style="overflow: auto;  white-space: nowrap;">
                <div class="card" style="width: 250px;text-align: center" th:each="component : ${components}">
                    <canvas th:value="${component.canvas}"></canvas>
                    <div class="card-body">
                        <h4 class="card-title" th:text="${component.name}"></h4>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <!--<div class="card-body">-->
                    <!--<div id="canvasContainer" class="d-flex flex-wrap" style="display: block;text-align: center;">-->
                        <!--&lt;!&ndash;<canvas id = "c1"></canvas>&ndash;&gt;-->
                        <!--&lt;!&ndash;<canvas id = "c2"></canvas>&ndash;&gt;-->
                        <!--&lt;!&ndash;<canvas id = "c3"></canvas>&ndash;&gt;-->
                    <!--</div>-->
                <!--</div>-->

                <div class="card-body">
                    <div id="canvasContainer" class="d-flex flex-wrap" style="display: block;text-align: center;">
                        <th:block th:each="canvas, iterStat:${canvases}">
                            <canvas width="350" height="350" th:id = "${'c' + (iterStat.index + 1)}" th:value="${canvas}"></canvas>
                        </th:block>
                    </div>
                </div>

                <hr>

                <div class = "card-body">
                    <input type="text" id="about" style="text-align: center; width:100%; height: 50px;" placeholder="About" th:value="${about}">

                    <div class="d-flex justify-content-center">
                        <span>Make Comic Public</span>
                        <input type="checkbox" id = "isPublic" th:checked="${isPublic == true ? 'true' : 'false'}">
                    </div>

                    <button id = "publish" type="button" class="btn btn-primary btn-block" style="margin-top:10px;" th:text="${button}">Publish</button>
                    <i class="import fas fa-upload" style="border-left: #dad7d9 solid 1px;margin-top:10px;width:100%;text-align: center;">
                        <p>Import</p>
                    </i>
                </div>

                <hr>

            </div>
        </div>
    </div>
    <!-- /.row -->

</div>
<!-- /.container -->


<!--Scripts-->
<script>
    var comicSlides = {};
    var currentCanvas;
    var count = 1;
    var shape;
    var toolType;
    var fill = "transparent";
    var stroke = "black";
    var strokeWidth = 2;
    var isDown = false;
    var origX;
    var origY;

    $(document).ready(function () {
        // addCanvas();

        // comicSlides["c1"] = new fabric.Canvas("c1", { width: 350, height: 350 });
        // comicSlides["c2"] = new fabric.Canvas("c2", { width: 350, height: 350 });
        // comicSlides["c3"] = new fabric.Canvas("c3", { width: 350, height: 350 });

        var oldTitle = $("#title").val();

        if(oldTitle != ""){
            console.log("title:" + title);
            $("#canvasContainer > canvas").each(function (e) {
                var canvas = $(this).attr("value");
                var id = $(this).attr("id");
                comicSlides[id] = new fabric.Canvas(id, { width: 350, height: 350 });
                comicSlides[id].loadFromJSON(canvas);
                count++;
            })

        }else{
            addCanvas();
            addCanvas();
            addCanvas();
        }

        setCurrentCanvas("c1");
        removeCanvasListener();
        console.log("count: " + count);

        $("#components > .card").on("click", function(event){
            console.log($(this).children()[0]);
            var canvas = $(this).children()[0].fabric;
            var group = new fabric.Group(canvas.getObjects());
            currentCanvas.add(group).renderAll();
        })

        $("#components > div > canvas").each(function(e) {
            var firstCanvas = $(this).attr("value");
            $(this).attr("value", "");
            var canvas = new fabric.StaticCanvas(this, { width: 200, height: 200 });
            this.fabric = canvas;
            canvas.loadFromJSON(firstCanvas);

            var objects = canvas.getObjects();
            var factorX = 200/900;
            var factorY = 200/900;

            var tcounter = 0;

            for (var i in objects) {

                tcounter++;

                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * factorX;
                var tempScaleY = scaleY * factorY;
                var tempLeft = left * factorX;
                var tempTop = top * factorY;

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;
                objects[i].setCoords();
            }
            canvas.renderAll();
            canvas.calcOffset();
        });

        currentCanvas.freeDrawingBrush.width = parseInt($("#drawing-line-width").val(), 10) || 1;

        $("#canvasContainer").on('click', 'div', function (event) {
            console.log("new handler " + $(this).children()[0].id);
            var id = $(this).children()[0].id;
            if(id != null && id != "canvasContainer" && id != currentCanvas.lowerCanvasEl.id ){
                removeCanvasListener();
                setCurrentCanvas(id);
            }
        });

        $("#shape-stroke-width").change(function(){
            strokeWidth = parseInt(this.value, 10) || 1;
            this.previousSibling.innerHTML = this.value;
        });

        $("#shape-stroke").change(function(){
            stroke = this.value;
        });

        $("#shape-fill").change(function(){
            fill = this.value;
        });

        $("#drawing-color").change(function(){
            currentCanvas.freeDrawingBrush.color = this.value;
            stroke = this.value;
        });

        $("#drawing-line-width").change(function(){
            currentCanvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
            strokeWidth = parseInt(this.value, 10) || 1;
            this.previousSibling.innerHTML = this.value;
        });

        $("#tools").children().on("click", function () {
            staticMode();
            removeCanvasListener();
            var collapse = $(".selected").data("target");
            $(collapse).collapse('hide');

            $(this).addClass("selected").siblings().removeClass("selected");
            toolType = this.id;
            console.log(this);
            switch (toolType) {
                case "draw":
                    freeDrawingMode();
                    break;
                case "select":
                    selectTool();
                    break;
                case "image":
                    break;
                case "eraser":
                    break;
                case "clear":
                    clearCanvas();
                    break;
                case "addCanvas":
                    addCanvas();
                    break;
                case "deleteCanvas":
                    deleteCanvas();
                    break;
                default:
                    initializeCanvasListener();
                    break;
            }
        });

        $("#publish").on("click", function () {
            var title = $("#title").val();
            var about = $("#about").val();
            var button = $(this).text();

            console.log("button name: " + button);

            if(title == '' || about ==''){
                alert("Please Fill Out All The Fields");
                return;
            }

            var canvases = createComicJsonArray();
            if(canvases == "empty"){
                alert("Please Create Content on All Canvases or Delete Unnecessary Canvases");
                return;
            }

            console.log(title);
            console.log(about);
            console.log(canvases);
            if(canvases.length == 1){
                canvases.push("bug");
            }

            var isPublic = false;
            if($('#isPublic').is(':checked')){
                isPublic = true;
            }

            if(button == "Publish"){
                $.post('/addComic',   // url
                    { title: title, about: about, canvases: canvases, isPublic: isPublic }, // data to be submit
                    function(data, status, jqXHR) {// success callback
                        console.log('status: ' + status + ', data: ' + data);
                        window.location = "/";
                });
            }else{

                $.post('/updateComic',   // url
                    { oldTitle : oldTitle, title: title, about: about, canvases: canvases, isPublic: isPublic }, // data to be submit
                    function(data, status, jqXHR) {// success callback
                        console.log('status: ' + status + ', data: ' + data);
                        window.location = "/";
                });

            }
        })

    });

    function initializeCanvasListener() {
        currentCanvas.on('mouse:down', mouseDown);
        currentCanvas.on('mouse:up', mouseUp);
        currentCanvas.on('mouse:move', mouseMove);
    }

    function removeCanvasListener(){
        currentCanvas.off('mouse:down', mouseDown);
        currentCanvas.off('mouse:up', mouseUp);
        currentCanvas.off('mouse:move', mouseMove);
    }
    
    function mouseDown() {
        if(toolType != "circle" && toolType != "rectangle"&& toolType != "line" && toolType != "triangle" && toolType != "text"){
            return;
        }
        console.log("mouse down");

        var pointer = currentCanvas.getPointer(this.e);
        isDown = true;
        origX = pointer.x;
        origY = pointer.y;

        if(toolType == "circle"){

            shape = new fabric.Circle({
                left: pointer.x,
                top: pointer.y,
                radius: 1,
                strokeWidth: strokeWidth,
                stroke: stroke,
                fill: fill,
                originX: 'center',
                originY: 'center',
                selectable: false
            });

        }else if(toolType == "rectangle"){

            shape = new fabric.Rect({
                left:origX,
                top:origY,
                strokeWidth: strokeWidth,
                stroke: stroke,
                fill: fill,
                selectable: false
            });

        }else if(toolType == "line"){

            var points = [origX, origY, origX, origY];

            shape = new fabric.Line(points, {
                strokeWidth: strokeWidth,
                stroke: stroke,
                selectable: false
            });

        }else if(toolType == "triangle"){

            shape = new fabric.Triangle({
                left: pointer.x,
                top: pointer.y,
                strokeWidth: strokeWidth,
                stroke: stroke,
                fill: fill,
                width:2,
                height:2,
                originX: 'center',
                selectable: false
            });

        }else if(toolType == "text"){
            var text = new fabric.IText('',{
                left: origX,
                top: origY
            });
            currentCanvas.add(text).setActiveObject(text);
            text.enterEditing();
            isDown = false;
            return;
        }
        currentCanvas.add(shape);
    }
    
    function mouseUp() {
        if(toolType != "circle" && toolType != "rectangle"&& toolType != "line" && toolType != "triangle"){
            return;
        }
        console.log("mouse up");

        shape.setCoords();
        isDown = false;
    }
    
    function mouseMove() {
        if(toolType != "circle" && toolType != "rectangle" && toolType != "line" && toolType != "triangle"){
            return;
        }

        if (!isDown) return;

        console.log("mouse move");

        var pointer = currentCanvas.getPointer(this.e);

        if(toolType == "circle"){

            shape.set({ radius: Math.abs(origX - pointer.x) });

        }else if(toolType == "rectangle"){

            if(origX>pointer.x){
                shape.set({ left: Math.abs(pointer.x) });
            }
            if(origY>pointer.y){
                shape.set({ top: Math.abs(pointer.y) });
            }

            shape.set({ width: Math.abs(origX - pointer.x) });
            shape.set({ height: Math.abs(origY - pointer.y) });

        }else if(toolType == "line"){

            shape.set({ x2: pointer.x, y2: pointer.y });

        }else if(toolType == "triangle"){

            shape.set({ width: Math.abs(origX - pointer.x),height: Math.abs(origY - pointer.y)});

        }
        currentCanvas.renderAll();
    }

    function addCanvas() {
        console.log("entering add");
        var content = document.getElementById("canvasContainer");
        var newCanvas = document.createElement("canvas");
        newCanvas.id = "c" + count++ + "";
        content.appendChild(newCanvas);
        comicSlides[newCanvas.id] = new fabric.Canvas(newCanvas.id, { width: 350, height: 350 });
        setCurrentCanvas(newCanvas.id);
    }

    function setCurrentCanvas(canvasId) {
        console.log("setting current canvas: ");
        if (typeof currentCanvas != "undefined") {
            console.log(currentCanvas.lowerCanvasEl.id);
            currentCanvas.discardActiveObject().renderAll();
            currentCanvas.isDrawingMode = true;
            // console.log("cursor " + currentCanvas.hoverCursor);
            currentCanvas.hoverCursor = 'context-menu';
            changeMode();
        }
        currentCanvas = comicSlides[canvasId];
        selectTool();
        currentCanvas.hoverCursor = 'move';
        $(".upper-canvas").css("border", ".5px solid black");

        $(".lower-canvas").css("border", ".5px solid black");

        $(currentCanvas.upperCanvasEl).css("border", "2px solid red");
        console.log(canvasId);
    }

    function changeMode() {
        console.log(currentCanvas.isDrawingMode);
        var collapse = $(".selected").data("target");
        $(collapse).collapse('hide');
        $(".selected").removeClass("selected");
        currentCanvas.isDrawingMode = !currentCanvas.isDrawingMode;
    }

    function freeDrawingMode(){
        currentCanvas.isDrawingMode = true;
    }

    function staticMode(){
        currentCanvas.isDrawingMode = false;
        currentCanvas.selection = false;
        currentCanvas.hoverCursor = 'context-menu';
        currentCanvas.forEachObject(function(object){
            object.selectable = false;
        })
        currentCanvas.renderAll();
    }

    function deleteCanvas(){
        var choice = confirm("Are You Sure You Want To Remove This Canvas?")
        $(".selected").removeClass("selected");
        if(choice == true){
            var numberOfCanvases = Object.keys(comicSlides).length
            if(numberOfCanvases == 1){
                alert("Need At least One Canvas");
                return;
            }
            var id = currentCanvas.lowerCanvasEl.id;
            currentCanvas.dispose();
            delete comicSlides[id];
            var newCurrent = $("#" + id).siblings()[0].firstChild.id;
            currentCanvas = undefined;
            setCurrentCanvas(newCurrent)
            document.getElementById(id).parentNode.removeChild(document.getElementById(id));
        }else {
            return;
        }
    }

    function clearCanvas(){
        if(!currentCanvas.getActiveObject()){
            var choice = confirm("Are You Sure You Want To Clear The Canvas?");
            if(choice == true){
                currentCanvas.clear();
            }else {
                return
            }
        }else{
            currentCanvas.remove(currentCanvas.getActiveObject());
        }
    }

    function selectTool(){
        console.log("entering select tool");
        $("#select").addClass("selected");
        currentCanvas.selection = true;
        currentCanvas.hoverCursor = 'move';
        currentCanvas.forEachObject(function(object){
            object.selectable = true;
        })
        currentCanvas.renderAll();
    }

    function resetControls(){

    }

    function createComicJsonArray(){
        var comicJsonArray= [];
        for(var i = 1; i <= count; i++){
            var key = "c" + i;
            if(key in comicSlides){
                console.log("key: " + key);
                var json = comicSlides[key].toJSON();
                if(json['objects'].length == 0){
                    return "empty";
                }
                json = JSON.stringify(comicSlides[key]);
                comicJsonArray.push(json);
            }
        }

        return comicJsonArray;
    }

    //Onbeforeunload is used in in single-page applications when there is some unsaved data in the browser.
    //You use this to make sure that the user does not accidentally leave the page. This will prompt the user
    //with the option to leave or stay on the page.
    window.onbeforeunload = function() {
        return "Do you want to leave the page without saving your progress?";
    };
</script>

</body>

</html>